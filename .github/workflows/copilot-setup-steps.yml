name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      # also build whenever the nix files changes so that we have a populated cache
      - flake.nix
      - flake.lock
  
jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # I'm not sure if this is effective for the job, but we saw copilot killing the jobs after exactly 30 minutes
    # which was the previous timeout value
    timeout-minutes: 120 

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read
      # > For purging, the workflow or the job must have the permission actions: write.
      # https://github.com/nix-community/cache-nix-action?tab=readme-ov-file
      actions: write

    # this is the equivalent of a local `docker-compose up`
    services:
      mailhog:
        image: europe-west3-docker.pkg.dev/meshstack-infra/dockerhub/mailhog/mailhog
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
          - 1025:1025
          - 8025:8025
        
      keycloak:
        image: europe-west3-docker.pkg.dev/meshstack-infra/meshstack-container/keycloak-ci:23
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
          - 5050:8080
          - 8443:8443
        
          
      ravendb:
        image: europe-west3-docker.pkg.dev/meshstack-infra/meshstack-container/ravendb-ci
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
          - 4040:4040
          - 38888:38888

      rabbitmq:
        image: europe-west3-docker.pkg.dev/meshstack-infra/dockerhub/rabbitmq:3.11.18-alpine
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
          - 5672:5672
          - 15672:15672

      # this image contains a db dump with pre-run migrations
      mariadb-meshfed-api:
        image: europe-west3-docker.pkg.dev/meshstack-infra/meshstack-container/mariadb-ci
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
          - 3306:3306

      mariadb-meshfed-api-docs:
        image: library/mariadb:11.0.3
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: test
          MYSQL_TCP_PORT: 3307
          MYSQL_UNIX_PORT: 3307
        ports:
          - 3307:3307

      # it seems we don't need this for actual builds, i.e. its not listed in ci.yml either
      # iirc that's because we use H2 for tests in blockcoordinator
      # mariadb-blockcoordinator-api:
      #   image: library/mariadb:11.0.3
      #   env:
      #     MYSQL_ROOT_PASSWORD: root
      #     MARIADB_DATABASE: backend
      # ports:
      #   - "3308:3306"

      mariadb-kraken-api:
        image: library/mariadb:11.0.3
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: backend
          MYSQL_TCP_PORT: 3309
          MYSQL_UNIX_PORT: 3309
        ports:
          - 3309:3309

      osb:
        image: europe-west3-docker.pkg.dev/meshstack-infra/meshstack-container/osb-build
        credentials:
          username: _json_key
          password: ${{ secrets.GCR_REGISTRY_PUSHER }}
        ports:
        - 8075:8075
    
    steps:
      - name: Set runner environment
        run: |
          echo "GITHUB_RUNNER_ENVIRONMENT=${{ runner.environment }}" >> $GITHUB_ENV
          

          
      # NOTE: 
      # > Any value that is set for the fetch-depth option of the actions/checkout action will be overridden to allow the agent to rollback commits upon request, while mitigating security risks. For more information, see actions/checkout/README.md.
      # https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment
      # To workaround this, we have started adding support in local builds to work with a shallow clone as well.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Note: we can't use ./.github/actions/setup-nix here because the container support for copilot is broken
      # in GitHub Copilot Coding Agent. 
      # See https://support.github.com/ticket/3680658
      # > I have received final confirmation from Engineering that we are not going to support container for the time being, and will update the documentation to reflect this.
      # As an alternative, we setup a nix cache and install the tools which is reasonably
      # fast on GitHub hosted runners (but dog slow on self-hosted runners).
      # Self-hosted runners pull the nix container from our docker registry (which is fast on self hosted runners, but slow on GitHub hosted runners).
      - name: Setup Nix environment
        uses: ./.github/actions/cache-nix
        
      # todo: we might be able to reasonably combine this with using the nodejs, gradle cache etc. as well
      # BUT what is missing here is to prevent pushing the caches from copilot, which i'd never want to allow?
      # ALSO setup-nix atm. expects that it runs in the nix container (ie. /tmp/flake path) and we'd need to make it
      # more flexible than that.
      - name: Setup development environment
        run: nix profile install .#tools

      # restore the local gradle cache to speed up the first gradle startup like we do in ci.yml
      - uses: gradle/actions/setup-gradle@v4

      - name: Validate development environment
        run: |
          echo "=== Validating meshStack Development Environment ==="
          echo "Java: $(java -version 2>&1 | head -n1)"
          echo "Node: $(node --version)"
          echo "Yarn: $(yarn --version)"
          echo "Go: $(go version)"
          echo "Python: $(python3 --version)"
          echo "CI Environment: $CI"
          echo "Runner Environment: $GITHUB_RUNNER_ENVIRONMENT"
          echo ""
          echo "âœ… All tools are available and ready for Copilot!"
      
      - name: Wait for dependent services to be ready
        timeout-minutes: 5
        run: |          
          ci/scripts/waitport 3306 mariadb
          ci/scripts/waitport 3307 mariadb
          ci/scripts/waitport 3309 mariadb
          ci/scripts/waitport 4040 ravendb
          ci/scripts/waitport 5050 keycloak
          ci/scripts/waitport 5672 rabbitmq
          ci/scripts/waitport 8025 mailhog

      # Copilot coding agent is not very patient with builds and often runs into "staggered" timeouts like 
      # trying 60s, then 90s, then 120s etc. before aborting and attempting another approach.
      # Since we instruct copilot to always do builds before commiting, we add a warmup step here to ensure
      # that a lot of gradle work has been done before copilot starts its work. Since copilot starts from a develop
      # branch, most of the time we should also be able to fetch a lot from the gradle cache.
      - name: warm up gradle
        run: ./gradlew assemble
